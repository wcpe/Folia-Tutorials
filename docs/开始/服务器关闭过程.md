---
sidebar_position: 6
---
## 服务器关闭过程✨

Folia的服务器关闭过程也与原版不同。 这个过程运行在一个单独的线程。

运行逻辑是：

1. 停止区块更新。
2. 停止度量数据处理。
3. 禁用插件。
4. 停止接受新的玩家连接。
5. 给所有玩家发送断开连接包（但不踢出玩家）
6. 停止所有的区块处理系统。
7. 完成所有区域的待处理传送，然后保存所有世界的区块，最后保存世界的数据（level.dat 和其他 .dat 文件）。
8. 保存所有玩家数据。
9. 关闭资源管理器。
10. 释放地图数据相关的锁。
11. 停止剩余的执行器（Util 和 I/O 线程等）

与原版的区别是：

- 不在传送完成之前踢出玩家，因为踢出会保存玩家的dat文件。 也如前文所述可能此时传送暂未完成。

- 区块系统的停止在地图保存之前，减轻服务器在关闭时的负载。

- 实现方式取决于是有目的地的传送还是传送门传送。

- 对于有目的地的传送，会确保实体正常传送到目标地点，实体会在传送地点保存。

- 对于传送门传送，会让玩家停留在传送之前的地点，由于目标地点位置，仍旧进行寻找可能会损坏地图的数据。

必须在世界保存之前完成待处理传送，以便保存实体数据，因此只有在传送完成后才会保存玩家。
