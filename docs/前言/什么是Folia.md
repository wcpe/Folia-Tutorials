---
sidebar_position: 4
---
### 什么是Folia？

这是一个由PaperMC在2023.1发布的多线程服务端。

简单讲, Folia是Paper的分支(Fork)。 它就像Paper一样，作为服主**插件服务端**的一个选择，拥有Paper的特性，同时也拥有它自己的"特性"。

它实现了从上古时期就被诟病的问题： Minecraft服务端是运行在单线程上的(大部分)。《一核有难，多核围观》.jpg

因此很多服务器会选择提升单核性能、开群组服务器来解决玩家偏多后服务器TPS下降的问题。 通常情况下这种方式经济代价高且收效甚微。

> 你说的对 但是《Folia》是由PaperMC自主研发的一款全新多线程服务端。服务端运行在一个被称作「我的世界」的幻想世界，在这里，被神选中的人将被授予「多线程」，导引线程之力。你将扮演一位名为「史蒂夫」的神秘角色在服务器中与其他玩家体验插件服务器的乐趣，和他们一起体验生存，建造生电， 同时，逐步发掘「流畅」的真相。

---

官方测试时，使用2xAMD EPYC 7713(128c/256t @2.0GHz)  330+玩家在线游玩的情况下，tps没有明显下降的情况(19.00+)。

Folia将玩家附近的区块分组形成"独立加载的区域"。有关具体的实现原理，请自行阅读PaperMC文档。

每个区域的更新都是独立的，以20TPS的速率进行更新。这些更新在并行的线程池上执行。

没有了主线程的概念，每个区域的区域更新都拥有自己的主线程。

在玩家分散开的服务器中(例如生存？)，Folia会创建许多分散的区域，在可配置大小的线程池上并行地进行更新。因此，Folia适合这样的服务器。

更详细而抽象的描述，请参阅[Overview](https://docs.papermc.io/folia/reference/overview)。

因此这个服务端中不存在"主线程"的概念，不可避免的导致一些API无法使用。

几乎全部适用Paper的插件都不适用Folia，但PaperMC正在计划将来使Folia插件能支持Paper服务端。

所以Bukkit插件需要做出一些调整才可以在Folia中使用。


### 如何更好地使用Folia

服务器玩家越多Folia的特点才会越显著，这需要你的服务器至少要有16个核心。

官方的建议是先预先生成世界。这样会减少当玩家跑图什么所消耗服务器的线程数量。

这是Folia官方的估算，数据基于当时测试时330+玩家的数据。数据仅作参考。

你可以根据这些数据来分配服务器线程或增加线程。

- netty IO ：每200-300名玩家大概需要4个线程。

- 用于区块IO的线程：每200-300名玩家大概要3个线程

- 用于区块中数据处理的线程（如果提前生成世界的情况下）：每200-300名玩家大概要2个线程

- 如果没有预先生成世界，在测试的服务器中就算提供了16个线程区块生成仍然很慢。 (就像平常跑图 你跑出去但是区块是空的...)

- GC(垃圾回收)设置： ??? GC设置会分配并发线程，但你需要指明分配给它的线程数量。

>-XX:ConcGCThreads=n-XX:ParallelGCThreads=n

你需要给服务端分配指定的线程数量，在`config/paper-global.yml`中，修改`threaded-regions.threads`的值。并且分配完成后至少需要拥有20%的空闲线程。

以上数据均基于官方测试结果的粗略计算。你需要根据实际情况来做出调整。